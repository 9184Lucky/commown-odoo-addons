<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- Sale order initial payment of rental product may be deposits: write it on portal -->
  <template
      id="rental_sale_order_portal_content"
      name="Orders Followup Products Links"
      inherit_id="website_sale.sale_order_portal_content_inherit_website_sale">

    <xpath expr="//td[@id='product_name']" position="inside">
      <t t-if="line.product_id.is_rental and line.product_id.is_deposit">
        <span>(deposit)</span>
      </t>
    </xpath>

  </template>

  <template id="portal_contract_page" inherit_id="contract.portal_contract_page">

    <!-- Remove sections we do not want to display -->
    <xpath expr="//div[@t-if='contract.user_id']" position="replace"></xpath>
    <xpath expr="//section[hasclass('s_timeline')]" position="replace"></xpath>

    <!-- Add start date and commitment duration to details table -->
    <xpath
        expr="//table[@id='sales_order_table']//th[@name='th_recurring_interval']"
        position="after">
      <th name="th_rental_start_date" class="text-right">Rental start date</th>
      <th name="th_commitment_duration" class="text-right">Commitment duration</th>
    </xpath>

    <xpath
        expr="//table[@id='sales_order_table']//td[@name='td_recurring_interval']"
        position="after">
      <td name="td_rental_start_date" class="text-right">
        <span t-field="line.date_start"/>
      </td>
      <td name="td_commitment_duration" class="text-right">
        <span t-field="line.commitment_duration"/>
        <t t-if="line.recurring_rule_type=='daily'">Day(s)</t>
        <t t-if="line.recurring_rule_type=='weekly'">Week(s)</t>
        <t t-if="line.recurring_rule_type=='monthly'">Month(s)</t>
        <t t-if="line.recurring_rule_type=='monthlylastday'">Month(s) last day</t>
        <t t-if="line.recurring_rule_type=='quarterly'">Quarter(s)</t>
        <t t-if="line.recurring_rule_type=='semesterly'">Semester(s)</t>
        <t t-if="line.recurring_rule_type=='yearly'">Year(s)</t>
      </td>
    </xpath>

  </template>

  <template id="product_price" inherit_id="website_sale.product_price">

    <xpath expr="div" position="before">
      <div t-if="product.is_rental" class="product_price mt16">
        <p>
          <b t-if="product.is_deposit"
             class="deposit_price"><span>Initial deposit: </span><span t-esc="'%g' % (product.list_price / (product.rental_price or 1))"/> <span>lease payments</span></b>
        </p>
        <t t-set="contract_tmpl" t-value="product.sudo().contract_template_id"/>
        <p t-if="contract_tmpl.min_contract_duration">
          <b class="min_contract_duration"><span>Commitment duration: </span><span t-esc="contract_tmpl.min_contract_duration"/> <span t-esc="dict(contract_tmpl.fields_get()['recurring_rule_type']['selection'])[contract_tmpl.recurring_rule_type].lower()"/></b>
        </p>
        <h3>
          <span class="oe_price oe_rental_price" t-att-data-rental-ratio="product.list_price / (product.rental_price or 1)" style="white-space: nowrap;" t-esc="product.website_price * product.rental_price / (product.list_price or 1)" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/> <b t-field="product.rental_frequency"/>
        </h3>
        <script type="text/javascript" src="/product_rental/static/src/js/website_sale.js"/>
      </div>
    </xpath>

    <xpath expr="//h4//span[1]" position="before">
      <b t-if="product.is_rental and product.is_deposit" class="deposit_price">Initial deposit:</b>
    </xpath>

  </template>

<!-- XXX TO BE PORTED TO V12

  <template id="variants" inherit_id="website_sale.variants">

    ### Hide spans containing the extra prices in both select and radio inputs ###
    <xpath expr="//span[@t-if='value_id.price_extra']" position="replace">
    </xpath>
    <xpath expr="//span[@t-if='value_id.price_extra']" position="replace">
    </xpath>

  </template>

  <template id="cart_lines" inherit_id="website_sale.cart_lines">
    <xpath expr="//td[@t-if='line.product_id.product_tmpl_id']/div/a/strong/ancestor::div[1]" position="inside">
      <t t-if="line.product_id.product_tmpl_id.is_rental">
        (<t t-esc="line.product_id.website_price * line.product_id.rental_price / (line.product_id.list_price or 1)" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/> <span  t-field="line.product_id.rental_frequency"/>)
      </t>
      <t t-if="line.product_id.product_tmpl_id.is_rental and line.product_id.product_tmpl_id.is_deposit">
        <strong> - Deposit</strong>
      </t>
    </xpath>
  </template>

  <template id="payment" inherit_id="website_sale.payment">
    ### Add rental and deposit right after product display name ###
    <xpath expr="//td//*[contains(@t-field, 'display_name')]" position="after">
      <t t-if="line.product_id.product_tmpl_id.is_rental">
        (<t t-esc="line.product_id.website_price * line.product_id.rental_price / (line.product_id.list_price or 1)" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/> <span  t-field="line.product_id.rental_frequency"/>)
      </t>
      <t t-if="line.product_id.product_tmpl_id.is_rental and line.product_id.product_tmpl_id.is_deposit">
        <strong> - Deposit</strong>
      </t>
    </xpath>
  </template>

  <template id="confirmation" inherit_id="website_sale.confirmation">
    ### Add rental and deposit right after product display name ###
    <xpath expr="//td//*[contains(@t-esc, 'display_name')]" position="after">
      <t t-if="line.product_id.product_tmpl_id.is_rental">
        (<t t-esc="line.product_id.website_price * line.product_id.rental_price / (line.product_id.list_price or 1)" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/> <span  t-field="line.product_id.rental_frequency"/>)
      </t>
      <t t-if="line.product_id.product_tmpl_id.is_rental and line.product_id.product_tmpl_id.is_deposit">
        <strong> - Deposit</strong>
      </t>
    </xpath>
  </template>

-->

</odoo>
