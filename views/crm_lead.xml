<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <data>

    <!-- XXX used anyhow ? -->
    <record model="ir.ui.view" id="res_partner_risk_form">
      <field name="name">commown.lead.res.partner</field>
      <field name="model">res.partner</field>
      <field name="arch" type="xml">
        <form string="Lead Partner">
          <group>
            <field name="name"/>
            <field name="street"/>
            <field name="city"/>
          </group>
        </form>
      </field>
    </record>

    <record model="ir.ui.view" id="crm_case_form_view_oppor">
        <field name="name">commown.lead.form.opportunity</field>
        <field name="model">crm.lead</field>
        <field name="mode">primary</field> <!-- Crucial here: do not override the parent view -->
        <field name="inherit_id" ref="crm.crm_case_form_view_oppor"/>
        <field name="arch" type="xml">
          <xpath expr="//div[@class='oe_title']//h2[@class='o_row']" position="attributes">
            <attribute name="invisible">1</attribute>
          </xpath>
          <xpath expr="//field[@name='priority']/ancestor::group[1]" position="attributes">
            <attribute name="invisible">1</attribute>
          </xpath>
          <xpath expr="//field[@name='email_from']" position="attributes">
            <attribute name="invisible">1</attribute>
          </xpath>
          <xpath expr="//field[@name='phone']" position="attributes">
            <attribute name="invisible">1</attribute>
          </xpath>
          <xpath expr="//notebook/page[1]" position="before">
            <page name="before_call_risk_eval" string="Before call" autofocus="autofocus">
              <field name="web_searchurl"/>
              <group>
                <group name="email evaluation" >
                  <field name="email_rating" widget="priority"/>
                </group>
                <group name="web evaluation">
                  <field name="webid_unknown"/>
                  <field name="webid_rating" widget="priority"
                         attrs="{'invisible': [('webid_unknown', '=', True)]}"/>
                </group>
                <group>
                  <field name="webid_notes"/>
                </group>
              </group>
            </page>
            <page name="communication_process" string="Communication process">
              <group>
                <group name="normal_contacts" string="Normal contacts">
                  <field name="sent_collective_email"/>
                  <field name="first_phone_call"/>
                  <field name="second_phone_call"/>
                  <field name="email_boost"/>
                </group>
                <group name="conflicting_contacts" string="Conflicting contacts">
                  <field name="third_phone_call"/>
                  <field name="email_ultimatum"/>
                  <field name="registered_mail_sent"/>
                </group>
              </group>
            </page>
            <page name="phone_call" string="Phone call">
              <group name="product_data" string="Initial product data">
                <field name="orders_description" colspan="2" readonly="1"/>
              </group>
              <group name="personal_data" string="Initial personal data">
                <group>
                  <field readonly="1" name="contact_name"/>
                  <field readonly="1" name="street"/>
                  <field readonly="1" name="street2"/>
                  <field readonly="1" name="mobile"/>
                  <field readonly="1" name="partner_name" invisible="1"/>
                  <field readonly="1" name="function" invisible="1"/>
                  <field readonly="1" name="fax" invisible="1"/>
                </group>
                <group>
                  <field readonly="1" name="zip" class="oe_inline"/>
                  <field readonly="1" name="city"/>
                  <field readonly="1" name="state_id" invisible="1"/>
                  <field readonly="1" name="country_id"/>
                  <field readonly="1" name="email_from"/>
                </group>
                <group>
                  <field name="initial_data_notes" colspan="2"/>
                </group>
              </group>
              <group string="Marketing">
                <field name="campaign_id" />
                <field name="medium_id" />
                <field name="source_id" />
              </group>
              <group name="phonecall_validation" string="Phone call validation">
                <group>
                  <field name="identity_validated"/>
                  <field name="mobile_validated"/>
                  <field name="email_validated"/>
                </group>
                <group>
                  <field name="billing_address_validated"/>
                  <field name="delivery_address_validated"/>
                  <field name="address_hesitation"/>
                </group>
              </group>
              <group>
                <group name="technicalities" string="Technicalities">
                  <field name="technical_skills" widget="priority"/>
                  <field name="questions"/>
                </group>
                <group name="global_feeling" string="Global feeling">
                  <field name="global_feeling" widget="priority"/>
                  <field name="comments"/>
                </group>
              </group>
            </page>
            <page name="delivery" string="Delivery followup">
              <group>
                <group>
                  <field name="expedition_ref"/>
                  <field name="expedition_date"/>
                  <field name="delivery_date"/>
                </group>
                <group>
                  <field readonly="1" name="expedition_status"/>
                  <field readonly="1" name="expedition_status_fetch_date"/>
                  <field readonly="1" name="expedition_urgency_mail_sent"/>
                </group>
              </group>
              <group name="delivery_actions">
                <field name="start_contract_on_delivery"/>
                <field name="send_email_on_delivery"/>
                <field name="on_delivery_email_template_id"
                       attrs="{'invisible': [('send_email_on_delivery', '=', False)]}"/>
              </group>
            </page>
          </xpath>
          <xpath expr="//notebook/page[@name='lead']" position="replace">
          </xpath>
        </field>
    </record>

    <record id="action_start_contract" model="ir.actions.server">
      <field name="name">[commown] Start contract</field>
      <field name="model_id" ref="commown.model_crm_lead"/>
      <field name="sequence">5</field>
      <field name="state">code</field>
      <field name="code">
# "uid" is in env: action launched from GUI
if 'uid' in env or object.start_contract_on_delivery:
    if object.name.startswith('[SO') and ']' in object.name:
        so_name = object.name[1:object.name.index(']')]
        if '-' not in so_name:
            so_name += '-01'  # XXX backward compat

        contract = object.env['account.analytic.account'].search([
            ('name', 'like', so_name),
        ]).ensure_one()

        contract.update({'date_start': object.delivery_date, 'is_auto_pay': True})
        contract.update({'recurring_next_date': object.delivery_date})
      </field>
    </record>

    <record id="action_send_delivery_email" model="ir.actions.server">
      <field name="name">[commown] Send delivery email</field>
      <field name="model_id" ref="commown.model_crm_lead"/>
      <field name="sequence">10</field>
      <field name="state">code</field>
      <field name="code">
# "uid" is in env: action launched from GUI
if 'uid' in env or object.send_email_on_delivery:
    TEMPLATE_IDS = env.context.get('UNITTEST_TEMPLATE_IDS', {  # XXX hardcoded ids
        'LIVCFM': 33,
        'LIVGAR': 34,
        'MLVARS': 35,
        'LIVVOI': 36,
    })

    if object.on_delivery_email_template_id:
        object.message_post_with_template(object.on_delivery_email_template_id.id)
    else:
        for code, template_id in TEMPLATE_IDS.items():
            if (object.expedition_status
                    and object.expedition_status.startswith('[%s]' % code)):
                object.message_post_with_template(template_id)
                break
        else:
            template = env.ref('commown.mail_template_lead_start_error')
            template = template.with_context({
                'error': (
                    'Expedition status does not contain a code associated with'
                    ' a contract start email template.'),
                })
            # Recipients are not the followers: use template.send_mail instead
            # of message_post_with_template
            template.send_mail(object.id)
      </field>
    </record>

    <record id="lead product delivered" model="base.action.rule">
      <field name="name">[commown] Lead product delivered</field>
      <field name="model_id" ref="model_crm_lead"/>
      <field name="sequence">1</field>
      <field name="kind">on_write</field>
      <field name="filter_pre_domain">[('delivery_date', u'=', False)]</field>
      <field name="filter_domain">[('delivery_date', u'!=', False)]</field>
      <field name="server_action_ids" eval="[(6,0,[ref('commown.action_start_contract'), ref('commown.action_send_delivery_email')])]"/>
    </record>

  </data>

</odoo>
