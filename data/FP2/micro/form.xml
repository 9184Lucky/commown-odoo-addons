<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <data>

    <record id="fp2-micro" model="ir.ui.view">
      <field name="name">Self-troubleshoot an FP2 micro</field>
      <field name="type">qweb</field>
      <field name="key">website.self-troubleshoot-fp2-micro</field>
      <field name="arch" type="xml">
        <t t-name="website.self-troubleshoot-fp2-micro">
          <t t-call="commown-self-troubleshoot.web-layout">
            <t t-set="title">Commown - Auto-dépannage - Fairphone 2 : mon interlocuteur ne m'entend pas</t>
            <t t-set="head">
              <script type="text/javascript">
                $(document).ready(function() {

                  const wizard = setUpWizard($('#smartwizard'));

                  $('input[type="radio"][name="mute-solved"]').change(function () {
                    const isNo = this.value!=='yes';
                    wizard.toggleStep(2, isNo);
                    wizard.toggleStep(3, isNo);
                    wizard.toggleStep(4, isNo);
                    wizard.toggleStep(5, isNo);
                    wizard.toggleStep(6, !isNo);
                  });

                  $('#is_micro_test_ok').change(function () {
                    const isNo = this.value!=='yes';
                    wizard.toggleStep(3, !isNo);
                    wizard.toggleStep(4, isNo);
                    wizard.toggleStep(5, isNo);
                  });

                });
              </script>
            </t>

            <!-- Variables à modifier ici -->
            <t t-set="contract_name_like">FP2/</t>
            <t t-set="tag_names">Appareil FP2,FP MOD micro</t>
            <t t-set="issue_title">FP2 - Micro</t>
            <t t-set="issue_description_template">issue-description-fp2-micro</t>
            <t t-set="stage_pending" t-value="env.ref('commown_self_troubleshooting.stage_pending').id"/>
            <t t-set="stage_solved" t-value="env.ref('commown_self_troubleshooting.stage_solved').id"/>
            <t t-set="stage_long_term_followup" t-value="env.ref('commown_self_troubleshooting.stage_long_term_followup').id"/>
            <!-- Fin des variables à modifier -->

            <t t-set="partner" t-value="env.user.partner_id"/>
            <t t-set="contracts" t-value="env['account.analytic.account'].sudo().search([('partner_id', '=', partner.id), ('contract_template_id.name', 'like', contract_name_like), ('date_end', '=', False)])"/>
            <t t-set="delivery" t-value="env['res.partner'].browse(partner.address_get(['delivery']).get('delivery', partner.id))"/>

            <div class="container">
              <br/>
              <form action="/self-troubleshoot/" method="post" accept-charset="utf-8" id="myForm" role="form">

                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <input type="hidden" name="self-troubleshoot-type" id="self-troubleshoot-type" t-att-value="issue_title"/>
                <input type="hidden" name="tags" id="tags" t-att-value="tag_names"/>
                <input type="hidden" name="issue-description-template" id="issue-description-template" t-att-value="issue_description_template"/>

                <div id="smartwizard">
                  <ul>
                    <li><a href="#step-0">Contexte<br/><small>Appareil concerné</small></a></li>
                    <li><a href="#step-1">Étape 1<br/><small>Mode micro coupé</small></a></li>
                    <li disabled="disabled"><a href="#step-2">Étape 2<br/><small>Test de maintenance</small></a></li>
                    <li disabled="disabled"><a href="#step-3">Étape 3<br/><small>Test autre SIM</small></a></li>
                    <li disabled="disabled"><a href="#step-4">Étape 4<br/><small>Expédition</small></a></li>
                    <li disabled="disabled"><a href="#step-5">Étape 5<br/><small>Confirmation</small></a></li>
                    <li disabled="disabled"><a href="#step-6">Étape 6<br/><small>Problème résolu</small></a></li>
                    <li><a href="#step-7">Étape 7<br/><small>Contacter un humain</small></a></li>
                  </ul>

                  <div>
                    <t t-call="commown_self_troubleshooting.step-contract-choice"/>

                    <div id="step-1">
                      <h2>Mode micro coupé</h2>
                      <p> Tout d'abord, veuillez vérifier que vous n'avez pas activé le mode "micro coupé" ("mute" en anglais) lors des appels. Vous pouvez vérifier cela pendant un appel en jetant un oeil sur l'icône du micro.
                      </p>
                      <div id="form-step-1" role="form" data-toggle="validator">
                        <div class="form-group">
                          <label>Ce test a t-il permis de résoudre le problème ?</label>
                          <label class="radio-inline" for="mute-solved-yes">Oui</label>
                          <input type="radio" name="mute-solved" id="mute-solved-yes" value="yes" required="required" data-required-error="Dites-nous si ce test a permis de régler le problème."/>
                          <label class="radio-inline" for="mute-solved-no">Non</label>
                          <input type="radio" name="mute-solved" id="mute-solved-no" value="no" required="required"/>
                          <div class="help-block with-errors"/>
                        </div>
                      </div>
                    </div>

                    <div id="step-2">
                      <h2>Test de maintenance</h2>
                      <p> Afin de voir si le problème provient bien du micro (et non d’un problème logiciel / réseau ou haut parleur), veuillez vous rendre dans le menu <i>Paramètres > Maintenance > Checkup > Primary Microphone > Start test</i>.</p>
                      <p>Pendant le test, tenez le téléphone comme si vous appeliez, et parlez. Vous devez vous entendre en écho avec une demi-seconde de décalage. Si vous n’entendez rien ou que le son est mauvais, avec des grésillements par exemple, c’est que le micro est en panne et nous vous aiderons à le changer.</p>
                      <p>Veillez à faire le test en pinçant plus ou moins fortement le bas de votre téléphone (où se trouve justement le micro), car les faux contacts sont fréquents à cet endroit.</p>
                      <div id="form-step-2" role="form" data-toggle="validator">
                        <div class="form-group">
		          <label for="micro_model">Lors des tests, le micro est il :</label>
                          <select class="form-control" required="required" id="is_micro_test_ok" name="is_micro_test_ok" data-required-error="Veuillez sélectionner un élément de la liste ci-dessus.">
                            <option disabled="disabled" selected="1" value="">-- Choisir une réponse --</option>
                            <option value="yes">Fonctionnel</option>
                            <option value="no">Pas fonctionnel</option>
                          </select>
                          <div class="help-block with-errors"/>
                        </div>
                      </div>
                    </div>

                    <div id="step-3">
                      <h2>Test d'une autre carte SIM</h2>
                      <p> Si le test de maintenance montre que le
                      micro principal est fonctionnel mais que
                      l'interlocuteur ne vous entend toujours pas,
                      alors le problème peut venir de votre carte
                      SIM. Nous vous invitons donc à tester une autre
                      carte SIM en demandant à une personne de votre
                      entourage.
                      </p>
                      <p>Si lors de ces tests le micro fonctionne
                      correctement, il vous faudra donc changer de
                      carte SIM.
                      </p>
                      <p>Nous vous invitons à nous informer que vous
                      allez effectuer ce test de carte SIM. Nous
                      attendrons alors un retour de votre part et vous
                      relancerons si vous oubliez :-). Pour ce faire, il
                      suffit d'appuyer sur le bouton ci-dessous.
                      </p>
                      <div id="form-step-3" role="form" data-toggle="validator">
                        <div class="form-group">
                          <label for="more_info_step_3">Ajoutez ici toute information que vous jugerez utile :</label>
                          <textarea class="form-control" rows="3" id="more_info_step_3" name="more_info"/>
                        </div>

                        <div class="form-group">
                          <input type="hidden" name="stage_id" t-att-value="stage_long_term_followup"/>
                          <button type="submit" class="btn btn-primary" name="action" value="wait-simcard">Envoyer les informations</button>
                        </div>
                      </div>
                    </div>

                    <t t-call="commown_self_troubleshooting.step-ship-module">
                      <t t-set="step">4</t>
                      <t t-set="new_module">un nouveau module micro</t>
                    </t>

                    <div id="step-5">
                      <h2>Confirmation de votre demande</h2>
                      <p>En appuyant sur le bouton ci-dessous, vous
                      confirmerez votre demande d'envoi.</p>
                      <p>Vous aurez besoin d’un tout petit tournevis
                      cruciforme, de taille #0
                      (voir <a target="_blank" href="https://eustore.ifixit.com/fr/Outils/Tournevis-Cles/Tournevis-cruciforme-Phillips-n-0-iFixit-made-in-Germany.html">ici</a>).
                      Nous pouvons vous en prêter un à nous retourner
                      ensuite avec le module en panne.
                      </p>
                      <p>Une demande d'assistance va être créée
                      automatiquement lorsque vous aurez soumis ce
                      formulaire. Elle sera affichée ici, ce qui vous
                      donnera l'opportunité d'ajouter un mot à
                      l'attention de notre équipe de support, si besoin.
                      </p>

                      --<br/>
                      <p>L'équipe Commown,<br/>
                      <img alt="logo" src="https://shop.commown.coop/web/content/25787"/>
                      </p>
                      --<br/>

                      <div id="form-step-5" role="form" data-toggle="validator">

                        <div class="form-group">
                          <p>Avez-vous besoin d'un tournevis ?</p>
                          <label class="radio-inline" for="screwdriver-yes">Oui</label>
                          <input type="radio" name="screwdriver" id="screwdriver-yes" value="yes" required="required" data-required-error="Dites-nous si vous avez besoin d'un tournevis."/>
                          <label class="radio-inline" for="screwdriver-no">Non</label>
                          <input type="radio" name="screwdriver" id="screwdriver-no" value="no" required="required"/>
                          <div class="help-block with-errors"/>
                        </div>

                        <div class="form-group">
                          <label for="more_info_step_4">Ajoutez ici toute information que vous jugerez utile :</label>
                          <textarea class="form-control" rows="3" id="more_info_step_4" name="more_info"/>
                        </div>

                        <div class="form-group">
                          <input type="hidden" name="stage_id" t-att-value="stage_pending"/>
                          <button type="submit" class="btn btn-primary" name="action" value="ship">Confirmer ma demande</button>
                        </div>
                      </div>
                    </div>

                    <t t-call="commown_self_troubleshooting.step-self-solved">
                      <t t-set="step">6</t>
                    </t>

                    <div id="step-7">
                      <h2>Contacter un humain</h2> <p>Vous pouvez ici
                      directement créer une demande d'assistance à
                      notre intention en expliquant au mieux le souci
                      que vous rencontrez ci-dessous.</p>

                      --<br/>
                      <p>L'équipe Commown,<br/>
                      <img alt="logo" src="https://shop.commown.coop/web/content/25787"/>
                      </p>
                      --<br/>

                      <div id="form-step-7" role="form" data-toggle="validator">

                        <div class="form-group">
                          <label for="device_contract">Contrat de votre appareil :</label>
                          <select class="form-control" id="device_contract" name="device_contract" required="required">
                            <option disabled="disabled" selected="1" value="">-- Choisir une réponse --</option>
                            <t t-foreach="contracts" t-as="c">
                              <t t-set="date" t-value="c.date_start.split('-')"/>
                              <option t-att-value="c.id" t-esc="u'%s (démarré le %s/%s/%s)' % (c.name, date[2], date[1], date[0])"/>
                            </t>
                          </select>
                          <div class="help-block with-errors"/>
                        </div>

                        <div class="form-group">
                          <label for="more_info_step_6">En quoi pouvons-nous vous aider ?</label>
                          <textarea class="form-control" rows="3" required="required" id="more_info_step_6" name="more_info"/>
                        </div>

                        <div class="form-group">
                          <input type="hidden" name="stage_id" t-att-value="stage_pending"/>
                          <button type="submit" class="btn btn-primary" name="action" value="contact">Envoyer les informations</button>
                        </div>

                      </div>
                    </div>

                  </div>

                </div>
              </form>
            </div>

          </t>
        </t>
      </field>
    </record>

  </data>

</odoo>
