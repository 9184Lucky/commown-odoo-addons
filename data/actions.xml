<?xml version="1.0"?>
<odoo>

  <!-- Urban mine registration handling -->

  <record id="action_create_opportunity" model="ir.actions.server">
    <field name="name">[commown] Urban mine: create opportunity</field>
    <field name="model_id" ref="base.model_res_partner"/>
    <field name="sequence">5</field>
    <field name="state">code</field>
    <field name="code">
<![CDATA[
TEAM_ID = env.ref('urban_mine.urban_mine_managers').id
STAGE_ID = env.ref('urban_mine.stage1').id

lead = env['crm.lead'].create({
        'name': record.name + ' - ' + record.city,
        'partner_id': record.id,
        'type': 'opportunity',
        'stage_id': STAGE_ID,
        })
# Override post-create behaviour that auto-assigns team_id
lead.update({'team_id': TEAM_ID})
]]>
    </field>
  </record>

  <record id="action_got_registration" model="base.action.rule">
    <field name="name">[commown] Urban mine registration</field>
    <field name="model_id" ref="base.model_res_partner"/>
    <field name="sequence">1</field>
    <field name="kind">on_create</field>
    <field name="filter_domain">[(u'from_urban_mine', u'=', True)]</field>
    <field name="server_action_ids" eval="[(6,0,[ref('urban_mine.action_create_opportunity')])]"/>
  </record>

  <!-- Urban mine validation handling: send a label by email -->

  <record id="action_send_label" model="ir.actions.server">
    <field name="name">[commown] Urban mine: send label by email</field>
    <field name="model_id" ref="crm.model_crm_lead"/>
    <field name="sequence">5</field>
    <field name="state">code</field>
    <field name="code"><![CDATA[
if record.user_id:
    record = record.sudo(record.user_id)

email_template = env.ref("urban_mine.email_template_with_label").id
label = record.colissimo_fairphone_labels()
record.with_context({'default_attachment_ids': (label.id,)}).message_post_with_template(email_template)
]]>
    </field>
  </record>

  <record id="action_registration_validated" model="base.action.rule">
    <field name="name">[commown] Urban mine was validated</field>
    <field name="model_id" ref="crm.model_crm_lead"/>
    <field name="sequence">1</field>
    <field name="kind">on_write</field>
    <field name="filter_pre_domain">[(u'stage_id', u'not ilike', u'[urban-mine: send-label]')]</field>
    <field name="filter_domain">[(u'stage_id', u'ilike', u'[urban-mine: send-label]')]</field>
    <field name="server_action_ids" eval="[(6,0,[ref('urban_mine.action_send_label')])]"/>
  </record>

</odoo>
